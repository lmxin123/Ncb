(function(n,t){angular.module("schedulingApp",["ui.bootstrap"]).controller("SchedulingCtrl",function(i,r){var u={month:n("#PlayMonth"),modal:n("#schedulingModal"),copyModal:n("#copyModal"),province:n("#schedulingForm #Province"),region:n("#schedulingForm #Region"),openAreaContainer:n("#openAreaContainer"),playTimesContainer:n("#playTimesContainer"),adContainer:n("#adContainter"),schedulingForm:n("#schedulingForm"),beginPlayDate:n("#BeginPlayDate"),endPlayDate:n("#EndPlayDate"),adFilterForm:n("#adFilterFrom"),deviceID:n("#DeviceID"),sId:n("#ID"),btnDelete:n("#btnDelete"),now:new Date},s="input-validation-error",h=0,o=[],e=[],f=[],c=function(){var n,r;i.DateList=[];i.month=u.month.val();var t=i.month.split("-"),f=new Date(parseInt(t[0]),parseInt(t[1]),0),e=f.getDate(),o=["周日","周一","周二","周三","周四","周五","周六"];for(n=1;n<=e;n++)r=new Date(parseInt(t[0]),parseInt(t[1])-1,n),i.DateList.push({week:o[r.getDay()].replace("周",""),date:{day:n,date:i.month+"-"+(n<10?"0"+n.toString():n)}})},l=function(){if(i.scheduling.PlayTimes){var t=JSON.parse(i.scheduling.PlayTimes);n.each(u.playTimesContainer.find("input"),function(i,r){n.each(t,function(n,t){if(r.value===t.Value)return r.checked=!0,!1;r.checked=!1})})}},v=function(t){var r,f;if(!w()){common.alert("您选择的日期范围包含己排期的日期，请选择未排期的日期范围！",{timeOut:5e3});return}var e=n(t),h=e.parent(),s=h.find("td:first"),o=[];for(h.find("td.selected").each(function(t,i){n(i).data("sid")===""&&o.push(i)}),r=0;r<i.List.length;r++)for(f=0;f<i.List[r].Schedulings.length;f++)if(i.List[r].Schedulings[f].ID===e.data("sid")){i.scheduling=i.List[r].Schedulings[f];y(i.scheduling.Details);break}u.deviceID.val(s.data("deviceid"));u.sId.val(e.data("sid"));u.province.area({cityClass:"#City",districtClass:"#Region",inputCode:"#Code",inputText:"#Text",defaultProvince:i.scheduling.Province||"44",defaultCity:i.scheduling.City||"03",defaultRegion:i.scheduling.Region||null});i.scheduling.ID=e.data("sid");i.scheduling.DeviceID=s.data("deviceid");i.scheduling.DeviceName=s.text();i.scheduling.Loop=!0;i.scheduling.BeginPlayDate=i.scheduling.BeginPlayDate||n(o[0]).data("date");i.scheduling.EndPlayDate=i.scheduling.EndPlayDate||n(o[o.length-1]).data("date");i.expired=!1;p(i.scheduling.BeginPlayDate,i.scheduling.EndPlayDate);i.getAdList();u.modal.modal("show")},y=function(t){var r=[];n.each(t,function(n,t){r.push(t.AdvertisementID)});i.DelAdIDs=r},p=function(n,t){u.beginPlayDate.datetimepicker("update",n);u.endPlayDate.datetimepicker("setStartDate",n).datetimepicker("update",t)},w=function(){var t=0,i=0;return n.each(e,function(n,r){r.data("sid")!==""&&t++;r.data("sid")===""&&i++}),!(t>0&&i>0)},b=function(n){for(var t=0;t<i.AdList.length;t++)if(i.AdList[t].ID===n){i.scheduling.PlayCount=i.AdList[t].PlayCount;i.scheduling.PlayTimes=i.AdList[t].PlayTimes;l();break}},a={minView:"month",format:"yyyy-mm-dd",language:"zh-CN",autoclose:!0,startDate:u.now};i.pageSize=20;i.totalItems=0;i.currentPage=1;i.adPageSize=5;i.adTotalItems=0;i.adCurrentPage=1;i.month=u.month.val();i.List=[];i.DateList=[];i.AdList=[];i.scheduling={};i.DelAdIDs=[];i.DeviceListLeft=[];i.DeviceListRight=[];i.SchedulingList=[];i.CancelCopyIds=[];i.getList=function(){r({method:"POST",url:"/adScheduling/getList",headers:{"Content-Type":undefined},transformRequest:function(n){return n=new FormData(t.getElementById("queryForm")),n.append("pageIndex",i.currentPage),n.append("pageSize",i.pageSize),n}}).success(function(n){n.Success?(n.Data.length===0&&common.alert("未查到数据！"),i.List=n.Data,i.totalItems=n.TotalCount):(common.alert(n.Message),i.List=[],i.totalItems=0)}).error(function(){common.alert("出现错误或者网络异常");i.List=[];i.totalItems=0})};i.getAdList=function(){r({method:"POST",url:"/adScheduling/getAdList",headers:{"Content-Type":undefined},transformRequest:function(n){return n=new FormData(t.getElementById("adFilterFrom")),n.append("pageIndex",i.adCurrentPage),n.append("pageSize",i.adPageSize),n}}).success(function(n){n.Success?(i.AdList=n.Data,i.adTotalItems=n.TotalCount):(common.alert(n.Message),i.AdList=[],i.adTotalItems=0)}).error(function(){common.alert("出现错误或者网络异常！");i.AdList=[];i.adTotalItems=0})};i.getDeviceLeft=function(n,t,u){r.post("/adScheduling/getHasSchedulingDevices",{queryText:t||i.queryTxtLeft,deviceId:n}).success(function(n){u?u(n):n.Success?i.DeviceListLeft=n.Data:(common.alert(n.Message),i.DeviceListLeft=[])}).error(function(){common.alert("出现错误或者网络异常！");i.DeviceListLeft=[]})};i.getDeviceRight=function(){r.post("/adScheduling/getDeviceList",{queryText:i.queryTxtRight,filterDeviceId:i.deviceIdLeft}).success(function(n){n.Success?i.DeviceListRight=n.Data:(common.alert(n.Message),i.DeviceListRight=[])}).error(function(){common.alert("出现错误或者网络异常！");i.DeviceListRight=[]})};i.getScheduling=function(t,u){var f=n(u.target);(f.prev().click(),f.attr("aria-expanded")!=="true")&&r.post("/adScheduling/getListByDeviceId",{deviceId:t}).success(function(r){r.Success?(i.SchedulingList=r.Data,setTimeout(function(){var i=n("#"+t).find("div.popover-content"),r=i.clone().removeClass("hidden").html();n("[data-toggle='popover']").popover({trigger:"hover",html:!0,delay:{hide:200},content:r})},10)):commom.alert(r.Message||"出错了！")}).error(function(){common.alert("出现错误或者网络异常！")})};i.copyTo=function(){var t=[],u=n('input[name= "deviceLeft"]:checked').val(),e=[],f=[],o;if(u||t.push("请选择被复制终端！"),o=n("#"+u).find("input"),o.length>0&&(o.filter(":checked").each(function(){e.push(this.value)}),e.length===0&&t.push("请选择终端排期！")),n('[name="deviceRight"]:checked').each(function(){f.push(this.value)}),f.length===0&&t.push("请选择目标终端！"),n.each(f,function(i,r){r===u&&(t.push("不允许把终端的排期复制到终端本身！"),n('input[name="deviceRight"][value="'+u+'"]').parent().addClass(s))}),t.length>0){common.alert(t.join("<br>"));return}r.post("/adScheduling/copyTo",{deviceIdLeft:u,schedulingIds:e,deviceIds:f}).success(function(n){n.Success?(i.CancelCopyIds=n.Data,i.getList(),common.alert("复制成功！")):common.alert(n.Message,5e3)}).error(function(){common.alert("网络异常！")})};i.copyThisDevice=function(t){i.getDeviceLeft(t,"",function(t){t.Success?(i.DeviceListLeft=t.Data,n('[data-target="#copyModal"]').click()):(common.alert("此终端无有效排期！"),i.DeviceListLeft=[])})};i.cancelCopy=function(){r.post("/adScheduling/cancelCopy",{schedulingIds:i.CancelCopyIds}).success(function(n){n.Success?(common.alert("撤销成功！"),i.CancelCopyIds=[],i.getList()):common.alert(n.Message)}).error(function(){common.alert("出现错误或者网络异常！")})};i.tdInit=function(n,t){for(var f,e,i={selected:"",sid:null},u=new Date(n),r=0;r<t.length;r++)if(f=new Date(t[r].BeginPlayDate),e=new Date(t[r].EndPlayDate),u>=f&&u<=e){i.selected="selected";i.sid=t[r].ID;break}return!i.sid&&u<new Date&&(i.selected="expire"),i};i.tdClick=function(n){n.target.classList.contains("expire")||(n.target.style.backgroundColor="dodgerblue")};i.down=function(n){if(!n.target.classList.contains("expire")){var t=n.clientX,i=n.clientY;o.push(Array(t,i));h=1}};i.move=function(t){var f=t.clientX,u=t.clientY,i,r;o.length>0&&(i=n(t.target),u<=o[0][1]+t.target.offsetWidth&&u>=o[0][1]-10&&1===h&&t.target.tagName==="TD"&&(i.addClass("selected"),r=!1,n.each(e,function(n,t){if(i.data("date")===t.data("date")){r=!0;return}}),r||e.push(i)))};i.up=function(t){t.target.classList.contains("expire")||(o=[],h=0,v(t.target),n.each(e,function(n,t){t.data("sid")===""&&t.removeClass("selected")}),e=[])};i.setDetailCheck=function(t){var r=!1;return n.each(i.scheduling.Details,function(i,u){if(u.AdvertisementID===t||n.inArray(t,f)!==-1){r=!0;return}}),r};i.check=function(t,i){i.target.checked?(b(t),(f.length===0||n.inArray(t,f)===-1)&&f.push(t)):n.each(f,function(n){if(f[n]===t)return f.splice(n,1),!1})};i.toolBarChange=function(n){if(n!==0){var t=new Date(i.month);u.month.datetimepicker("update",new Date(t.setMonth(t.getMonth()+n)))}else u.month.datetimepicker("update",u.now);c();i.getList()};u.modal.on("show.bs.modal",function(){u.playTimesContainer.find("input").length===0?n.get("/adScheduling/getPlayTimesSelectorPartial",function(n){u.playTimesContainer.html(n);l()},"html"):l()});u.modal.on("hidden.bs.modal",function(){i.scheduling={};e=[];u.adContainer.removeClass(s)});u.copyModal.on("hidden.bs.modal",function(){i.DeviceListLeft=[];i.DeviceListRight=[];i.SchedulingList=[];i.CancelCopyIds=[]});u.month.datetimepicker({startView:"year",minView:"year",format:"yyyy-mm",language:"zh-CN",autoclose:!0,initialDate:u.now.getFullYear()+"-"+u.now.getMonth()}).on("change",function(){c();i.getList()});u.beginPlayDate.datetimepicker(a).on("changeDate",function(n){u.endPlayDate.datetimepicker("setStartDate",n.date).datetimepicker("show")});u.endPlayDate.datetimepicker(a);c();n("#btnCreate").ajaxClick({formSelector:"#schedulingForm",loadingText:"正在保存...",onBefore:function(){var f=n('[name="PlayTime"]:checked'),e=u.adContainer.find('[name="adId"]:checked'),o=[],r=[],h=[],t=[];return(f.length===0?(u.playTimesContainer.addClass(s),t.push("请选择播放时段！")):f.each(function(t,i){o.push({Value:i.value,Checked:"Checked",Name:n.trim(n(i).parent().text())})}),e.length===0?(u.adContainer.addClass(s),t.push("请选择播放内容！")):(e.each(function(n,t){r.push(t.value)}),i.DelAdIDs.length>0&&n.each(i.DelAdIDs,function(t,i){var u=!1;n.each(r,function(n,t){if(i===t)return u=!0,!1});u||h.push(i)})),t.length>0)?(common.alert(t.join("<\/br>"),5e3),!1):{OpenAreas:JSON.stringify([]),PlayTimes:JSON.stringify(o),AdIDs:r.join("|"),DelAdIDs:h.join("|")}},onCompleted:function(n,t){n.Success?(common.alert("保存成功"),i.getList(),u.modal.modal("hide")):common.alert(n.Message||"保存失败，请稍后再试！");t.reset()}});u.btnDelete.ajaxClick({url:"/adScheduling/delete",loadingText:"正在删除...",onBefore:function(){return u.btnDelete.data("delete")?{id:i.scheduling.ID}:(u.btnDelete.text("确定要删除吗？"),u.btnDelete.data("delete",!0),!1)},onCompleted:function(n,t){n.Success?(common.alert("删除成功！"),u.modal.modal("hide"),i.getList()):common.alert(n.Message||"删除失败，请稍后再试！");t.reset()}})}).filter("areaFilter",function(){return exAreaCode})})($,document);